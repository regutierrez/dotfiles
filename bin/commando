#!/usr/bin/env bash

set -euo pipefail

eval "$(/opt/homebrew/bin/brew shellenv 2>/dev/null)" || true

command -v tmux >/dev/null 2>&1 || {
  printf 'tmux is required.\n' >&2
  exit 1
}
command -v fzf >/dev/null 2>&1 || {
  printf 'fzf is required.\n' >&2
  exit 1
}

selected="$(
  for root in "$HOME/repos" "$HOME/playground"; do
    [[ -d "$root" ]] || continue
    for dir in "$root"/*; do
      [[ -d "$dir" ]] && printf '%s\n' "$dir"
    done
  done | fzf --prompt='Project > ' --reverse
)" || exit 0

[[ -n "$selected" ]] || exit 0
session="$(basename "$selected")"

if ! tmux has-session -t "$session" 2>/dev/null; then
  tmux new-session -d -s "$session" -c "$selected"
fi

if [[ -n "${TMUX:-}" ]]; then
  tmux switch-client -t "$session"
else
  tmux attach-session -t "$session"
fi
