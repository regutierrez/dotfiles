#!/usr/bin/env bash

set -euo pipefail

ROOTS=("$HOME/repos" "$HOME/playground")
CONFIG_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/commando/layouts.sh"
SAVED_LAYOUTS_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/commando/saved-layouts"

# Optional override in ~/.config/commando/layouts.sh:
# commando_layout_for() {
#   local project="$1"
#   local project_dir="$2"
#
#   COMMANDO_LAYOUT="single"
#   COMMANDO_SERVER_TOP_CMD=""
#   COMMANDO_SERVER_BOTTOM_CMD=""
#
#   case "$project" in
#     my-app)
#       COMMANDO_LAYOUT="triple"
#       COMMANDO_SERVER_TOP_CMD="bun run dev"
#       COMMANDO_SERVER_BOTTOM_CMD="bun run backend:dev"
#       ;;
#   esac
# }
commando_layout_for() {
  COMMANDO_LAYOUT="single"
  COMMANDO_SERVER_TOP_CMD=""
  COMMANDO_SERVER_BOTTOM_CMD=""
}

if [[ -f "$CONFIG_FILE" ]]; then
  # shellcheck source=/dev/null
  source "$CONFIG_FILE"
fi

ensure_tmux() {
  if ! command -v tmux >/dev/null 2>&1; then
    printf 'tmux is required but not installed.\n' >&2
    exit 1
  fi
}

show_usage() {
  printf 'Usage:\n'
  printf '  commando\n'
  printf '  commando save [session-name]\n'
}

sanitize_session_name() {
  local name="$1"

  name="${name// /-}"
  name="${name//[^a-zA-Z0-9_-]/-}"

  while [[ "$name" == *--* ]]; do
    name="${name//--/-}"
  done

  name="${name#-}"
  name="${name%-}"

  if [[ -z "$name" ]]; then
    name="session"
  fi

  printf '%s\n' "$name"
}

is_shell_start_command() {
  local start_command="$1"
  local command_name

  if [[ -z "$start_command" ]]; then
    return 0
  fi

  command_name="${start_command%% *}"
  command_name="${command_name##*/}"
  command_name="${command_name#-}"

  case "$command_name" in
    bash|zsh|fish|sh|dash|ksh|csh|tcsh)
      return 0
      ;;
    *)
      return 1
      ;;
  esac
}

collect_projects() {
  local root dir
  PROJECTS=()

  for root in "${ROOTS[@]}"; do
    [[ -d "$root" ]] || continue

    for dir in "$root"/*; do
      [[ -d "$dir" ]] || continue
      PROJECTS+=("${dir#$HOME/}")
    done
  done

  if [[ ${#PROJECTS[@]} -eq 0 ]]; then
    printf 'No directories found in %s and %s.\n' "${ROOTS[0]}" "${ROOTS[1]}" >&2
    exit 1
  fi

  local sorted=()
  local item
  while IFS= read -r item; do
    [[ -n "$item" ]] && sorted+=("$item")
  done < <(printf '%s\n' "${PROJECTS[@]}" | sort -fu)

  PROJECTS=("${sorted[@]}")
}

pick_project() {
  local selected=""

  if command -v fzf >/dev/null 2>&1; then
    selected="$(printf '%s\n' "${PROJECTS[@]}" | fzf --prompt='Project > ' --height=40% --reverse)"
  else
    local i
    for ((i = 0; i < ${#PROJECTS[@]}; i++)); do
      printf '%2d) %s\n' "$((i + 1))" "${PROJECTS[$i]}"
    done

    read -r -p "Select project number > " i
    if [[ "$i" =~ ^[0-9]+$ ]] && (( i >= 1 && i <= ${#PROJECTS[@]} )); then
      selected="${PROJECTS[$((i - 1))]}"
    fi
  fi

  if [[ -z "$selected" ]]; then
    exit 0
  fi

  SELECTED_DIR="$HOME/$selected"

  if [[ ! -d "$SELECTED_DIR" ]]; then
    printf 'Selected directory does not exist: %s\n' "$SELECTED_DIR" >&2
    exit 1
  fi
}

create_triple_layout_session() {
  local session_name="$1"
  local project_dir="$2"
  local panes=()
  local pane_id

  tmux new-session -d -s "$session_name" -n dev -c "$project_dir"
  tmux new-window -t "$session_name:" -n code -c "$project_dir"
  tmux new-window -t "$session_name:" -n servers -c "$project_dir"
  tmux split-window -t "$session_name:servers" -v -c "$project_dir"

  while IFS= read -r pane_id; do
    panes+=("$pane_id")
  done < <(tmux list-panes -t "$session_name:servers" -F '#{pane_id}')

  if [[ ${#panes[@]} -ge 1 && -n "$COMMANDO_SERVER_TOP_CMD" ]]; then
    tmux send-keys -t "${panes[0]}" "$COMMANDO_SERVER_TOP_CMD" C-m
  fi

  if [[ ${#panes[@]} -ge 2 && -n "$COMMANDO_SERVER_BOTTOM_CMD" ]]; then
    tmux send-keys -t "${panes[1]}" "$COMMANDO_SERVER_BOTTOM_CMD" C-m
  fi

  tmux select-window -t "$session_name:dev"
}

create_saved_layout_session() {
  local session_name="$1"
  local saved_layout_file="$SAVED_LAYOUTS_DIR/${session_name}.sh"

  if [[ ! -f "$saved_layout_file" ]]; then
    return 1
  fi

  # shellcheck source=/dev/null
  source "$saved_layout_file"

  if ! declare -F commando_saved_layout >/dev/null 2>&1; then
    printf 'Saved layout file is invalid: %s\n' "$saved_layout_file" >&2
    exit 1
  fi

  commando_saved_layout "$session_name"
  unset -f commando_saved_layout
}

create_session() {
  local session_name="$1"
  local project_dir="$2"
  local project_name="$3"

  if create_saved_layout_session "$session_name"; then
    return
  fi

  commando_layout_for "$project_name" "$project_dir"

  case "$COMMANDO_LAYOUT" in
    triple)
      create_triple_layout_session "$session_name" "$project_dir"
      ;;
    *)
      tmux new-session -d -s "$session_name" -c "$project_dir"
      ;;
  esac
}

switch_or_attach() {
  local session_name="$1"

  if [[ -n "${TMUX:-}" ]]; then
    tmux switch-client -t "$session_name"
  else
    tmux attach-session -t "$session_name"
  fi
}

save_session_layout() {
  local source_session="$1"
  local layout_key="$2"
  local layout_file="$SAVED_LAYOUTS_DIR/${layout_key}.sh"
  local tmp_file
  local window_count=0
  local active_window_slot=0
  local -a active_pane_for_window=()
  local window_index window_name window_layout window_active

  mkdir -p "$SAVED_LAYOUTS_DIR"
  tmp_file="$(mktemp "${TMPDIR:-/tmp}/commando-layout.XXXXXX")"

  {
    printf '#!/usr/bin/env bash\n'
    printf '# Generated by commando on %s\n\n' "$(date '+%Y-%m-%d %H:%M:%S')"
    printf 'commando_saved_layout() {\n'
    printf '  local session_name="$1"\n\n'
  } > "$tmp_file"

  while IFS=$'\t' read -r window_index window_name window_layout window_active; do
    [[ -n "$window_index" ]] || continue

    local pane_index pane_path pane_start_command pane_active
    local pane_count=0
    local first_pane_path=""
    local active_pane_index=0
    local -a pane_paths=()
    local -a pane_commands=()

    while IFS=$'\t' read -r pane_index pane_path pane_start_command pane_active; do
      [[ -n "$pane_index" ]] || continue

      pane_paths[$pane_index]="$pane_path"
      pane_count=$((pane_count + 1))

      if [[ -z "$first_pane_path" ]]; then
        first_pane_path="$pane_path"
      fi

      if [[ "$pane_active" == "1" ]]; then
        active_pane_index="$pane_index"
      fi

      if [[ -n "$pane_start_command" ]] && ! is_shell_start_command "$pane_start_command"; then
        pane_commands[$pane_index]="$pane_start_command"
      fi
    done < <(tmux list-panes -t "$source_session:$window_index" -F '#{pane_index}\t#{pane_current_path}\t#{pane_start_command}\t#{pane_active}')

    if [[ -z "$first_pane_path" ]]; then
      first_pane_path="$HOME"
    fi

    printf '  local window_%d\n' "$window_count" >> "$tmp_file"
    if (( window_count == 0 )); then
      printf '  window_%d="$(tmux new-session -d -P -F %q -s "$session_name" -n %q -c %q)"\n' \
        "$window_count" '#{window_id}' "$window_name" "$first_pane_path" >> "$tmp_file"
    else
      printf '  window_%d="$(tmux new-window -P -F %q -t "$session_name:" -n %q -c %q)"\n' \
        "$window_count" '#{window_id}' "$window_name" "$first_pane_path" >> "$tmp_file"
    fi

    local pane_number pane_command
    for ((pane_number = 1; pane_number < pane_count; pane_number++)); do
      pane_path="${pane_paths[$pane_number]-$first_pane_path}"
      printf '  tmux split-window -t "${window_%d}" -c %q\n' "$window_count" "$pane_path" >> "$tmp_file"
    done

    printf '  tmux select-layout -t "${window_%d}" %q\n' "$window_count" "$window_layout" >> "$tmp_file"

    for ((pane_number = 0; pane_number < pane_count; pane_number++)); do
      pane_command="${pane_commands[$pane_number]-}"
      if [[ -n "$pane_command" ]]; then
        printf '  tmux respawn-pane -k -t "${window_%d}.%d" %q\n' \
          "$window_count" "$pane_number" "$pane_command" >> "$tmp_file"
      fi
    done

    printf '\n' >> "$tmp_file"

    if [[ "$window_active" == "1" ]]; then
      active_window_slot="$window_count"
    fi

    active_pane_for_window[$window_count]="$active_pane_index"
    window_count=$((window_count + 1))
  done < <(tmux list-windows -t "$source_session" -F '#{window_index}\t#{window_name}\t#{window_layout}\t#{window_active}')

  if (( window_count == 0 )); then
    rm -f "$tmp_file"
    printf 'No windows found in session: %s\n' "$source_session" >&2
    exit 1
  fi

  local selected_pane_index
  selected_pane_index="${active_pane_for_window[$active_window_slot]-0}"

  {
    printf '  tmux select-window -t "${window_%d}"\n' "$active_window_slot"
    printf '  tmux select-pane -t "${window_%d}.%d"\n' "$active_window_slot" "$selected_pane_index"
    printf '}\n'
  } >> "$tmp_file"

  mv "$tmp_file" "$layout_file"
  chmod 600 "$layout_file"
}

save_command() {
  local target_session="${1:-}"
  local layout_key

  if [[ -z "$target_session" ]]; then
    if [[ -n "${TMUX:-}" ]]; then
      target_session="$(tmux display-message -p '#S')"
    else
      printf 'Session name is required when not running inside tmux.\n' >&2
      show_usage >&2
      exit 1
    fi
  fi

  if ! tmux has-session -t "$target_session" 2>/dev/null; then
    printf 'Session does not exist: %s\n' "$target_session" >&2
    exit 1
  fi

  layout_key="$(sanitize_session_name "$target_session")"
  save_session_layout "$target_session" "$layout_key"

  printf 'Saved layout for session %s to %s\n' "$target_session" "$SAVED_LAYOUTS_DIR/$layout_key.sh"
}

main() {
  local command="${1:-}"

  ensure_tmux

  case "$command" in
    save)
      shift
      save_command "${1:-}"
      return
      ;;
    help|-h|--help)
      show_usage
      return
      ;;
    "")
      ;;
    *)
      printf 'Unknown command: %s\n' "$command" >&2
      show_usage >&2
      exit 1
      ;;
  esac

  collect_projects
  pick_project

  local project_name session_name
  project_name="$(basename "$SELECTED_DIR")"
  session_name="$(sanitize_session_name "$project_name")"

  if ! tmux has-session -t "$session_name" 2>/dev/null; then
    create_session "$session_name" "$SELECTED_DIR" "$project_name"
  fi

  switch_or_attach "$session_name"
}

main "$@"
